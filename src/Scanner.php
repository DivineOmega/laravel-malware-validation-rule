<?php

namespace DivineOmega\LaravelMalwareValidationRule;

use DivineOmega\LaravelMalwareValidationRule\Exceptions\MalwareScanFailedException;
use Socket\Raw\Factory;
use Xenolope\Quahog\Client;

class Scanner
{
    public function scanFile(string $file): ScanResult
    {
        $socket = (new Factory())->createClient('unix:///var/run/clamav/clamd.ctl');
        $client = new Client($socket, 30, PHP_NORMAL_READ);
        $result = $client->scanFile($file);

        $status = $result['status'];
        $reason = $result['reason'];
        dd($result);

        if ($status === Client::RESULT_ERROR) {
            throw new MalwareScanFailedException($reason);
        }

        $infected = $status === Client::RESULT_FOUND;
        $malware = $reason;

        return new ScanResult($infected, $malware);
    }
}