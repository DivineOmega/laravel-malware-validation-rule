<?php

namespace DivineOmega\LaravelMalwareValidationRule;

use DivineOmega\LaravelMalwareValidationRule\Exceptions\MalwareScanFailedException;
use Socket\Raw\Factory;
use Xenolope\Quahog\Client;

class Scanner
{
    public function scanFile(string $file): ScanResult
    {
        $socket = (new Factory())->createClient('unix:///var/run/clamav/clamd.ctl');
        $client = new Client($socket, 30, PHP_NORMAL_READ);
        $result = $client->scanFile($file);

        if ($result->hasFailed()) {
            throw new MalwareScanFailedException($result->getReason());
        }

        return new ScanResult($result->isFound(), $result->isFound() ? $result->getReason() : null);
    }
}