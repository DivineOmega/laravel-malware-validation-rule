<?php

use DivineOmega\LaravelMalwareValidationRule\Rules\Malware;
use Illuminate\Http\UploadedFile;
use PHPUnit\Framework\TestCase;

class MalwareRuleTest extends TestCase
{
    public function setUp(): void
    {
        file_put_contents(__DIR__.'/eicar.com.txt',
            file_get_contents('https://secure.eicar.org/eicar.com.txt')
        );
    }

    public function testRulePass()
    {
        $uploadedFile = new UploadedFile(__FILE__, 'safe-file');

        $passes = (new Malware())->passes('file', $uploadedFile);

        $this->assertTrue($passes);
    }

    public function testRuleFails()
    {
        $uploadedFile = new UploadedFile(__DIR__.'/eicar.com.txt', 'test-virus');

        $passes = (new Malware())->passes('file', $uploadedFile);

        $this->assertFalse($passes);
    }

    public function testRuleValidationMessage()
    {
        $uploadedFile = new UploadedFile(__DIR__.'/eicar.com.txt', 'test-virus');

        $rule = new Malware();
        $rule->passes('file', $uploadedFile);

        $expectedMessage = 'The uploaded file contains a virus/malware known as Eicar-Signature.';

        $this->assertEquals($expectedMessage, $rule->message());
    }

    public function testRuleValidationMessageWithoutMalwareName()
    {
        $uploadedFile = new UploadedFile(__DIR__.'/eicar.com.txt', 'test-virus');

        $showMalwareName = false;

        $rule = new Malware($showMalwareName);
        $rule->passes('file', $uploadedFile);

        $expectedMessage = 'The uploaded file contains a virus/malware.';

        $this->assertEquals($expectedMessage, $rule->message());
    }
}